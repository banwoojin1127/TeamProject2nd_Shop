<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìœ ì‚¬ ê³ ê° ê¸°ë°˜ ì¶”ì²œ í†µê³„</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        .recommend-container {
            background: #aa2020;
            border-radius: 8px;
            padding: 20px;
            margin-top: 0px;
            color: white;
        }
        .recommend-title {
            color: white;
            margin-bottom: 1rem;
        }

        #groupChart {
            width: 100%;
            max-width: 200px;  /* ğŸ”¥ ì°¨íŠ¸ ì¡°ê¸ˆ ë” í¬ê²Œ */
            margin: 0 auto;
        }

        .no-data {
            color: white;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="container recommend-container">
    <h5 class="mb-3">
        <span class="tooltip-container">
            ğŸ“Šìœ ì‚¬ê·¸ë£¹ì´ ë§ì´ êµ¬ë§¤í•œ ìƒí’ˆ ì¹´í…Œê³ ë¦¬
            <span class="tooltip-text">
                ìœ ì‚¬ê·¸ë£¹(ë³¸ì¸ë‚˜ì´Â±5, ë™ì¼ì„±ë³„)ì´ êµ¬ë§¤í•œ ì•„ì´í…œì¤‘
            </span>
        </span>
    </h4>

    {% if recommendations_json %}
        <canvas id="groupChart"></canvas>
    {% else %}
        <p class="no-data">ì¶”ì²œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {

    const jsonString = `{{ recommendations_json | safe }}`;

    let dataList = [];
    try {
        dataList = JSON.parse(jsonString);
    } catch (e) {
        console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        return;
    }

    if (!dataList.length) return;

    /* ğŸ”µ 1. ëŒ€ë¶„ë¥˜ ì´ë¦„ ë§¤í•‘ */
    const CATEGORY_PARENT = {
        1: "ê³¼ì¼", 2: "ì±„ì†Œ", 3: "ê³ ê¸°", 4: "í•´ì‚°ë¬¼",
        5: "ìŒ€/ì¡ê³¡/ê²¬ê³¼", 6: "ë¹µ", 7: "ê³¼ì", 8: "ìŒë£Œ"
    };

    /* ğŸ”µ 2. ì†Œë¶„ë¥˜ â†’ ëŒ€ë¶„ë¥˜ ë§¤í•‘ */
    const CATEGORY_MAP = {
        9:1,10:1,11:1,12:1,13:1,14:1,15:1,16:1,17:1,18:1,
        19:2,20:2,21:2,22:2,23:2,24:2,25:2,26:2,27:2,28:2,
        29:3,30:3,31:3,32:3,33:3,34:3,35:3,36:3,37:3,38:3,
        39:4,40:4,41:4,42:4,43:4,44:4,45:4,46:4,47:4,48:4,
        49:5,50:5,51:5,52:5,53:5,54:5,55:5,56:5,57:5,58:5,
        59:6,60:6,61:6,62:6,63:6,64:6,65:6,66:6,67:6,68:6,
        69:7,70:7,71:7,72:7,73:7,74:7,75:7,76:7,77:7,78:7,
        79:8,80:8,81:8,82:8,83:8,84:8,85:8,86:8,87:8,88:8
    };

    /* ğŸ”µ 3. ëŒ€ë¶„ë¥˜ë³„ ì§‘ê³„ */
    const categorySummary = {};

    dataList.forEach(item => {
        const parent = CATEGORY_MAP[item.item_category];
        const name = CATEGORY_PARENT[parent];

        if (!categorySummary[name]) {
            categorySummary[name] = 0;
        }
        categorySummary[name] += item.purchase_count || 0;
    });

    const labels = Object.keys(categorySummary);
    const values = Object.values(categorySummary);

    const ctx = document.getElementById('groupChart').getContext('2d');

    /* ğŸ¨ ğŸ”¥ íŒŒì´ ì°¨íŠ¸ (ê¸€ì ì•ˆìª½ í‘œì‹œ) */
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                borderWidth: 0,
                backgroundColor: [
                    '#4E79A7', '#F28E2B', '#E15759',
                    '#76B7B2', '#59A14F', '#EDC948',
                    '#B07AA1', '#FF9DA7'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },   // ğŸ”¥ ë°”ê¹¥ ë²”ë¡€ ì œê±°

                datalabels: {
                    color: '#ffffff',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    formatter: (value, context) => {
                        return context.chart.data.labels[context.dataIndex];
                    },

                    // ğŸ”¥ íŒŒì´ ì•ˆìª½ ì¤‘ì•™ì— í‘œì‹œ
                    anchor: 'center',
                    align: 'center',
                    offset: 0
                }
            }
        },
        plugins: [ChartDataLabels]
    });

});
</script>

</body>
</html>
