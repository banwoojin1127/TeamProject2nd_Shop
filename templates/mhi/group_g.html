<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìœ ì‚¬ ê³ ê° ê¸°ë°˜ ì¶”ì²œ í†µê³„</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .recommend-container {
            background: #3f6093;
            border-radius: 12px;
            padding: 20px;
            margin-top: 0px;
        }
        .recommend-title {
            color: white;
            margin-bottom: 1rem;
        }
        #groupChart {
            width: 100%;
            max-width: 240px;
            margin: 0 auto;
        }
        .no-data {
            color: white;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="container recommend-container" >
    <h4 class="recommend-title" style="font-size: 16px; margin-bottom: 8px;" >ğŸ“Š ë‚˜ì™€ ë¹„ìŠ·í•œ ìœ ì €ê°€ êµ¬ë§¤í•œ ì¹´í…Œê³ ë¦¬</h4>

    {% if recommendations_json %}
        <canvas id="groupChart"></canvas>
    {% else %}
        <p class="no-data">ì¶”ì²œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const jsonString = `{{ recommendations_json | safe }}`;

    let dataList = [];
    try {
        dataList = JSON.parse(jsonString);
    } catch (e) {
        console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        return;
    }

    if (!dataList.length) return;

    /* ğŸ”µ 1. ëŒ€ë¶„ë¥˜ ë§¤í•‘ (parent_id ê¸°ì¤€) */
    const CATEGORY_PARENT = {
        1: "ê³¼ì¼",
        2: "ì±„ì†Œ",
        3: "ê³ ê¸°",
        4: "í•´ì‚°ë¬¼",
        5: "ìŒ€/ì¡ê³¡/ê²¬ê³¼",
        6: "ë¹µ",
        7: "ê³¼ì",
        8: "ìŒë£Œ"
    };

    /* ğŸ”µ 2. ì†Œë¶„ë¥˜ item_category â†’ ëŒ€ë¶„ë¥˜ parent_id ë³€í™˜ í•„ìš”
       item_category(=ì†Œë¶„ë¥˜) â†’ parent_idë¥¼ ëª¨ë¥´ë©´ JSì—ì„œ ì§ì ‘ ë§¤í•‘í•´ì•¼ í•¨ */

    // ğŸ”¥ ì†Œë¶„ë¥˜â†’ëŒ€ë¶„ë¥˜ ë§¤í•‘ ì§ì ‘ ì…ë ¥ (DB ê¸°ì¤€)
    const CATEGORY_MAP = {
        // ê³¼ì¼ (1)
        9:1,10:1,11:1,12:1,13:1,14:1,15:1,16:1,17:1,18:1,

        // ì±„ì†Œ (2)
        19:2,20:2,21:2,22:2,23:2,24:2,25:2,26:2,27:2,28:2,

        // ê³ ê¸° (3)
        29:3,30:3,31:3,32:3,33:3,34:3,35:3,36:3,37:3,38:3,

        // í•´ì‚°ë¬¼ (4)
        39:4,40:4,41:4,42:4,43:4,44:4,45:4,46:4,47:4,48:4,

        // ìŒ€/ì¡ê³¡/ê²¬ê³¼ (5)
        49:5,50:5,51:5,52:5,53:5,54:5,55:5,56:5,57:5,58:5,

        // ë¹µ (6)
        59:6,60:6,61:6,62:6,63:6,64:6,65:6,66:6,67:6,68:6,

        // ê³¼ì (7)
        69:7,70:7,71:7,72:7,73:7,74:7,75:7,76:7,77:7,78:7,

        // ìŒë£Œ (8)
        79:8,80:8,81:8,82:8,83:8,84:8,85:8,86:8,87:8,88:8
    };

    /* ğŸ”µ 3. ëŒ€ë¶„ë¥˜ë³„ êµ¬ë§¤ íšŸìˆ˜ í•©ì‚° */
    const categorySummary = {};

    dataList.forEach(item => {
        const sub = item.item_category;           // 9, 10, 19, ...
        const parent = CATEGORY_MAP[sub];         // 1, 2, 3, ...
        const parentName = CATEGORY_PARENT[parent];

        if (!categorySummary[parentName]) {
            categorySummary[parentName] = 0;
        }
        categorySummary[parentName] += item.purchase_count || 0;
    });

    /* ğŸ”µ 4. ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ */
    const labels = Object.keys(categorySummary);
    const values = Object.values(categorySummary);

    const ctx = document.getElementById('groupChart').getContext('2d');

    /* ğŸ”¥ íŒŒì´ ì°¨íŠ¸ ì¶œë ¥ */
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: "#ffffff" }
                }
            }
        }
    });

});
</script>

</body>
</html>
