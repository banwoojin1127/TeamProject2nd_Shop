<div class="recommendation-graph-section">

{% set MIN_REVIEW = 50 %}
{% set filtered_list = [] %}

{% for item in weighted_recommendations_list %}
    {% if item.item_reviewcnt is not none and item.item_reviewcnt|int >= MIN_REVIEW %}
        {% set _ = filtered_list.append(item) %}
    {% endif %}
{% endfor %}

{% set filtered_json = filtered_list | tojson %}

{% if filtered_list %}

<h4 class="mb-3">
    <span class="tooltip-container">
        <br>
        &nbsp; ğŸ“ˆ ìœ ì‚¬ê·¸ë£¹ ìµœì¢… ì•„ì´í…œ ì¶”ì²œê·¸ë˜í”„
        <span class="tooltip-text">
            ê°€ì¤‘ì¹˜(í‰ì =0.5, êµ¬ë§¤ìˆ˜=0.2, ë¦¬ë·°ìˆ˜=0.3)ë¥¼ ì ìš©í•œ ìœ ì‚¬ê·¸ë£¹ ì¶”ì²œ ê²°ê³¼ì…ë‹ˆë‹¤.  
            â€» ë¦¬ë·° ìˆ˜ëŠ” ë¶„í¬ í¸ì°¨ ì™„í™”ë¥¼ ìœ„í•´ log ë³€í™˜ ì ìš©
        </span>
    </span>
</h4>

<div style="width: 100%; height: 500px;">
    <canvas id="itemComparisonChart"></canvas>
</div>

{% else %}
<div class="alert alert-info" role="alert">
    ë¦¬ë·° {{ MIN_REVIEW }}ê°œ ì´ìƒì¸ ì¶”ì²œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
</div>
{% endif %}

</div>

<script>
/* ===============================
   ë°ì´í„° ì¤€ë¹„
================================ */
const recommendationData = JSON.parse('{{ filtered_json | safe }}');
const topN = 6;
const topItems = recommendationData.slice(0, topN);

// ìƒí’ˆëª…
const itemNames = topItems.map(item =>
    item.product_name.length > 15
        ? item.product_name.substring(0, 15) + '...'
        : item.product_name
);

// ì ìˆ˜ ê¸°ì—¬ë„
const rateParts = [];
const reviewParts = [];
const purchaseParts = [];

// ë§í’ì„ ìš© ì„¤ëª… ë°ì´í„°
const tooltipDescriptions = [];

topItems.forEach(item => {
    const totalNorm =
        item.norm_rate +
        item.norm_review +
        item.norm_purchase;

    const totalScore = item.weighted_score;

    const rateScore = totalScore * item.norm_rate / totalNorm;
    const reviewScore = totalScore * item.norm_review / totalNorm;
    const purchaseScore = totalScore * item.norm_purchase / totalNorm;

    rateParts.push(rateScore.toFixed(3));
    reviewParts.push(reviewScore.toFixed(3));
    purchaseParts.push(purchaseScore.toFixed(3));

    tooltipDescriptions.push({
        name: item.product_name,
        total: totalScore.toFixed(3),
        rateScore: rateScore.toFixed(3),
        reviewScore: reviewScore.toFixed(3),
        purchaseScore: purchaseScore.toFixed(3)
    });
});

/* ===============================
   Chart.js
================================ */
const ctx = document.getElementById('itemComparisonChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: itemNames,
        datasets: [
            {
                label: 'í‰ì  ê¸°ì—¬ ì ìˆ˜',
                data: rateParts,
                backgroundColor: 'rgba(255, 99, 132, 0.85)'
            },
            {
                label: 'ë¦¬ë·° ê¸°ì—¬ ì ìˆ˜',
                data: reviewParts,
                backgroundColor: 'rgba(54, 162, 235, 0.85)'
            },
            {
                label: 'êµ¬ë§¤ ê¸°ì—¬ ì ìˆ˜',
                data: purchaseParts,
                backgroundColor: 'rgba(75, 192, 192, 0.85)'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                stacked: true,
                title: {
                    display: true,
                    text: 'ìƒí’ˆëª…'
                }
            },
            y: {
                stacked: true,
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'ì´ì  (Weighted Score)'
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    title: function(context) {
                        const i = context[0].dataIndex;
                        return tooltipDescriptions[i].name;
                    },
                    label: function(context) {
                        const i = context.dataIndex;
                        const d = tooltipDescriptions[i];
                        return [
                            `ì´ì : ${d.total}`,
                            `í‰ì  ê¸°ì—¬ ì ìˆ˜: ${d.rateScore}`,
                            `ë¦¬ë·° ê¸°ì—¬ ì ìˆ˜: ${d.reviewScore}`,
                            `êµ¬ë§¤ ê¸°ì—¬ ì ìˆ˜: ${d.purchaseScore}`
                        ];
                    }
                }
            },
            legend: {
                position: 'top'
            }
        }
    }
});
</script>
