<div class="recommendation-graph-section">
    
    {% set MIN_REVIEW = 50 %}
    
    {# 1. Jinja2ì—ì„œ í•„í„°ë§í•  ë³€ìˆ˜ ì¤€ë¹„ #}
    {% set filtered_list = [] %}
    
    {# 2. í•„í„°ë§: item_reviewcntê°€ MIN_REVIEW(50) ì´ìƒì¸ ì•„ì´í…œë§Œ filtered_listì— ì¶”ê°€ #}
    {% for item in weighted_recommendations_list %}
        {% if item.item_reviewcnt is not none and item.item_reviewcnt|int >= MIN_REVIEW %}
            {% set _ = filtered_list.append(item) %}
        {% endif %}
    {% endfor %}
    
    {# 3. í•„í„°ë§ëœ ëª©ë¡ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ JavaScriptì— ì „ë‹¬ #}
    {% set filtered_json = filtered_list | tojson %}

    {% if filtered_list %}

    <h4 class="mb-3">
        <span class="tooltip-container">
            ğŸ“ˆ ìœ ì‚¬ê·¸ë£¹ ìµœì¢… ì•„ì´í…œ ì¶”ì²œê·¸ë˜í”„
            <span class="tooltip-text">
                ìœ ì‚¬ê·¸ë£¹ ìµœì¢…ì•„ì´í…œ ì¶”ì²œ ê¸°ì¤€(í‰ì , ë¦¬ë·°ìˆ˜, êµ¬ë§¤íšŸìˆ˜ ê°€ì¤‘ì¹˜ í•©ì‚°)ì„ ì‹œê°í™”+ë¦¬ë·°ìˆ˜50ê°œì´ìƒ
            </span>
        </span>
    </h4>

    <div style="width: 100%; height: 500px;">
        <canvas id="itemComparisonChart"></canvas>
    </div>
    
    <script>
        // â­â­ ë¬¸ì œ í•´ê²°: filtered_jsonì„ ì‚¬ìš©í•˜ì—¬ íŒŒì‹± â­â­
        // ì´ ë°ì´í„°ëŠ” ì´ë¯¸ ë¦¬ë·° 50ê°œ ì´ìƒì¸ ìƒí’ˆë§Œ í¬í•¨í•©ë‹ˆë‹¤.
        const recommendationData = JSON.parse('{{ filtered_json | safe }}');
        
        // 2. ìƒìœ„ 6ê°œ ì•„ì´í…œë§Œ ì¶”ì¶œ (ê·¸ë˜í”„ ê°€ë…ì„±ì„ ìœ„í•´)
        const topN = 6;
        const topItems = recommendationData.slice(0, topN);

        // 3. ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
        // Xì¶•: ìƒí’ˆ ì´ë¦„
        const itemNames = topItems.map(item => {
            const name = item.product_name;
            return name.length > 15 ? name.substring(0, 15) + '...' : name;
        });

        // Yì¶• ë°ì´í„° (DAOì—ì„œ ì •ê·œí™”ëœ ê°’ ì‚¬ìš©: 0 ~ 1)
        const normRates = topItems.map(item => item.norm_rate.toFixed(3));
        const normReviews = topItems.map(item => item.norm_review.toFixed(3));
        const normPurchases = topItems.map(item => item.norm_purchase.toFixed(3));
        // ì´ì (Weighted Score)
        const weightedScores = topItems.map(item => item.weighted_score.toFixed(3)); 

        // 4. Chart.jsë¥¼ ì‚¬ìš©í•œ ê·¸ë£¹í˜• ì„¸ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        const ctx = document.getElementById('itemComparisonChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar', // ì„¸ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
            data: {
                labels: itemNames,
                datasets: [
                    // ì´ì  ë°ì´í„°ì…‹
                    {
                        label: 'ì´ì  (ê°€ì¤‘ì¹˜ ì ìˆ˜)',
                        data: weightedScores,
                        backgroundColor: 'rgba(255, 159, 64, 0.9)', 
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'í‰ì  (ì •ê·œí™”)',
                        data: normRates,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)', 
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'ë¦¬ë·° ìˆ˜ (ì •ê·œí™”)',
                        data: normReviews,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)', 
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'êµ¬ë§¤ ìˆ˜ (ì •ê·œí™”)',
                        data: normPurchases,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)', 
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'ìƒí’ˆëª…'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 1.0, 
                        title: {
                            display: true,
                            text: 'ì •ê·œí™”ëœ ì ìˆ˜ (0.0 ~ 1.0)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(3);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    </script>
    {% else %}
    <div class="alert alert-info" role="alert">
        ë¦¬ë·° {{ MIN_REVIEW }}ê°œ ì´ìƒì¸ ì¶”ì²œ ìƒí’ˆì´ ì—†ê±°ë‚˜, ì¶”ì²œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>
    {% endif %}
</div>